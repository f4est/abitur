<template>
  <div>
    <div v-if="isLoading" class="text-center py-12">
      <p class="text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
    </div>
    
    <div v-else-if="!school" class="text-center py-12">
      <p class="text-gray-500">–£—á–µ–±–Ω–æ–µ –∑–∞–≤–µ–¥–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</p>
      <NuxtLink to="/catalog" class="btn btn-primary mt-4">
        –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫–∞—Ç–∞–ª–æ–≥—É
      </NuxtLink>
    </div>
    
    <div v-else>
      <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –æ—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
      <div class="flex flex-col md:flex-row gap-4 sm:gap-6 mb-4 sm:mb-8">
        <div class="md:w-1/4">
          <div class="bg-white rounded-lg shadow-md p-4 flex items-center justify-center h-48 md:h-64">
            <ImageLoader
              :src="school.logoUrl"
              :alt="school.name"
              placeholder-type="school-logo"
              :name="school.name"
              class="max-w-full max-h-full"
            />
          </div>
        </div>
        
        <div class="md:w-3/4">
          <div class="bg-white rounded-lg shadow-md p-4 sm:p-6">
            <div class="flex justify-between items-start">
              <h1 class="text-xl sm:text-2xl md:text-3xl font-bold mb-2 sm:mb-4">{{ school.name }}</h1>
              
              <!-- –ë–ª–æ–∫ —Å —Ä–µ–π—Ç–∏–Ω–≥–æ–º -->
              <div v-if="school.averageRating" class="flex items-center bg-ashleigh bg-opacity-10 text-ashleigh px-3 py-2 rounded-md">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1.5" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118l-2.8-2.034c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                </svg>
                <span class="font-medium text-lg">{{ school.averageRating }}</span>
                <span class="text-sm text-gray-600 ml-1">({{ school.reviewCount }})</span>
              </div>
            </div>
            
            <div class="flex items-start text-gray-600 mb-3 sm:mb-4">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
              </svg>
              <span class="text-sm sm:text-base">{{ school.address }}</span>
            </div>
            
            <div class="flex flex-wrap gap-2 sm:gap-4 mb-4">
              <a
                v-if="school.websiteUrl"
                :href="school.websiteUrl"
                target="_blank"
                rel="noopener noreferrer"
                class="btn btn-primary text-sm sm:text-base"
              >
                –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–∞–π—Ç
              </a>
              
              <button
                @click="toggleSaveSchool"
                class="w-12 h-12 flex items-center justify-center rounded-full bg-white shadow hover:bg-gray-100 transition-colors"
                :class="{ 'text-red-500': isSaved }"
                :title="isSaved ? '–£–¥–∞–ª–∏—Ç—å –∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö' : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'"
                aria-label="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —É—á–µ–±–Ω–æ–µ –∑–∞–≤–µ–¥–µ–Ω–∏–µ"
              >
                <svg class="w-7 h-7" :fill="isSaved ? 'currentColor' : 'none'" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                </svg>
              </button>
            </div>
            
            <div class="border-t pt-3 sm:pt-4">
              <h2 class="text-lg sm:text-xl font-semibold mb-2">–ö–æ–Ω—Ç–∞–∫—Ç—ã</h2>
              
              <!-- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã -->
              <div class="space-y-3">
                <!-- –û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–ª–µ—Ñ–æ–Ω –∏ email -->
                <div class="flex flex-col sm:flex-row gap-2 sm:gap-4">
                  <div v-if="school.phone" class="flex items-start">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-ashleigh flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                    </svg>
                    <span class="text-sm sm:text-base">{{ school.phone }}</span>
                  </div>
                  <div v-if="school.email" class="flex items-start">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-ashleigh flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                    <span class="text-sm sm:text-base">{{ school.email }}</span>
                  </div>
                </div>
                
                <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–µ–ª–µ—Ñ–æ–Ω—ã -->
                <div v-if="contactData.phones && contactData.phones.length > 0" class="flex items-start">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-ashleigh flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" />
                  </svg>
                  <div class="flex flex-col">
                    <span class="text-sm font-medium mb-1">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–æ–º–µ—Ä–∞:</span>
                    <div class="space-y-1">
                      <div v-for="(phone, index) in contactData.phones" :key="`phone-${index}`" class="text-sm">
                        {{ phone }}
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- –§–∞–∫—Å -->
                <div v-if="contactData.fax" class="flex items-start">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-ashleigh flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <div class="flex flex-col">
                    <span class="text-sm font-medium">–§–∞–∫—Å:</span>
                    <span class="text-sm">{{ contactData.fax }}</span>
                  </div>
                </div>
                
                <!-- –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä—ã -->
                <div v-if="contactData.messengers && contactData.messengers.length > 0" class="flex items-start">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-ashleigh flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                  </svg>
                  <div class="flex flex-col">
                    <span class="text-sm font-medium mb-1">–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä—ã:</span>
                    <div class="space-y-1">
                      <div v-for="(messenger, index) in contactData.messengers" :key="`messenger-${index}`" class="text-sm flex items-center">
                        <span class="mr-1">{{ getMessengerIcon(messenger.type) }}</span>
                        <span>{{ messenger.value }}</span>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- –ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã -->
                <div v-if="contactData.workingHours" class="flex items-start">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-ashleigh flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <div class="flex flex-col">
                    <span class="text-sm font-medium">–ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã:</span>
                    <span class="text-sm">{{ contactData.workingHours }}</span>
                  </div>
                </div>
                
                <!-- –°–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ—Ç–∏ -->
                <div v-if="contactData.socialNetworks && contactData.socialNetworks.length > 0" class="flex items-start">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-ashleigh flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                  </svg>
                  <div class="flex flex-col">
                    <span class="text-sm font-medium mb-1">–°–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ—Ç–∏:</span>
                    <div class="flex flex-wrap gap-2">
                      <a 
                        v-for="(social, index) in contactData.socialNetworks" 
                        :key="`social-${index}`"
                        :href="social.url"
                        target="_blank"
                        rel="noopener noreferrer"
                        class="text-sm px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center"
                      >
                        <span class="mr-1">{{ getSocialIcon(social.type) }}</span>
                        <span>{{ getSocialName(social.type) }}</span>
                      </a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- –§–æ—Ç–æ–≥–∞–ª–µ—Ä–µ—è -->
      <div class="bg-white rounded-lg shadow-md p-4 sm:p-6 mb-4 sm:mb-8">
        <h2 class="text-lg sm:text-2xl font-semibold mb-2 sm:mb-4">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</h2>
        
        <div v-if="!school.photos || school.photos.length === 0" class="bg-gray-100 rounded-lg p-4 sm:p-8 text-center">
          <p class="text-gray-500">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</p>
        </div>
        
        <div v-else class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 sm:gap-4">
          <div
            v-for="photo in school.photos"
            :key="photo.id"
            class="h-40 sm:h-48 bg-gray-200 rounded-lg overflow-hidden group relative cursor-pointer"
            @click="openGallery(photo.url, photo.description)"
          >
            <ImageLoader
              :src="photo.url"
              :alt="photo.description || school.name"
              placeholder-type="school-photo"
              class="w-full h-full transition-transform duration-300 group-hover:scale-105"
            />
            <div class="absolute inset-0 bg-black/0 group-hover:bg-black/30 transition-all duration-300 flex items-end">
              <div v-if="photo.description" class="bg-black/70 text-white w-full py-2 px-3 translate-y-full group-hover:translate-y-0 transition-transform duration-300 text-sm">
                {{ photo.description }}
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π -->
      <div v-if="galleryOpen" class="fixed inset-0 z-50 bg-black/90 flex items-center justify-center">
        <div class="relative w-full h-full flex flex-col">
          <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
          <div class="flex justify-between items-center p-4 text-white">
            <div class="text-lg">
              {{ currentImageIndex + 1 }} –∏–∑ {{ school.photos.length }}
            </div>
            <button @click="closeGallery" class="text-white hover:text-red-500">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
          
          <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ -->
          <div class="flex-grow flex items-center justify-center p-4">
            <ImageLoader 
              :src="currentImage" 
              :alt="currentDescription"
              placeholder-type="school-photo"
              class="max-h-full max-w-full object-contain"
            />
          </div>
          
          <!-- –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π -->
          <div class="p-4 text-white">
            <div v-if="currentDescription" class="text-center mb-4 text-lg">
              {{ currentDescription }}
            </div>
            
            <div class="flex justify-center gap-4">
              <button 
                @click="prevImage" 
                class="bg-white/20 hover:bg-white/40 p-2 rounded-full"
                :disabled="currentImageIndex === 0"
                :class="{ 'opacity-50 cursor-not-allowed': currentImageIndex === 0 }"
              >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
              </button>
              
              <button 
                @click="nextImage" 
                class="bg-white/20 hover:bg-white/40 p-2 rounded-full"
                :disabled="currentImageIndex === school.photos.length - 1"
                :class="{ 'opacity-50 cursor-not-allowed': currentImageIndex === school.photos.length - 1 }"
              >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
      <div class="bg-white rounded-lg shadow-md p-4 sm:p-6 mb-4 sm:mb-8">
        <h2 class="text-lg sm:text-2xl font-semibold mb-2 sm:mb-4">–û–ø–∏—Å–∞–Ω–∏–µ</h2>
        <p class="whitespace-pre-wrap text-sm sm:text-base">{{ school.description }}</p>
      </div>
      
      <!-- –ö–∞—Ä—Ç–∞ -->
      <SchoolMap :address="school.address" :schoolName="school.name" :coordinates="school.coordinates" />
      
      <!-- –û—Ç–∑—ã–≤—ã –∏–∑ 2GIS -->
      <ExternalReviews :schoolId="school.id" :schoolName="school.name" :schoolAddress="school.address" />
      
      <!-- –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–±—É—á–µ–Ω–∏—è -->
      <div class="bg-white rounded-lg shadow-md p-4 sm:p-6 mb-4 sm:mb-8">
        <h2 class="text-lg sm:text-2xl font-semibold mb-2 sm:mb-4">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–±—É—á–µ–Ω–∏—è</h2>
        
        <div v-if="!school.programs || school.programs.length === 0" class="bg-gray-100 rounded-lg p-4 sm:p-8 text-center">
          <p class="text-gray-500">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö –æ–±—É—á–µ–Ω–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</p>
        </div>
        
        <div v-else class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200 text-sm sm:text-base">
            <thead>
              <tr>
                <th class="px-2 sm:px-6 py-2 sm:py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  –ù–∞–∑–≤–∞–Ω–∏–µ
                </th>
                <th class="px-2 sm:px-6 py-2 sm:py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">
                  –ö–æ–¥
                </th>
                <th class="px-2 sm:px-6 py-2 sm:py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  –°—Ä–æ–∫ –æ–±—É—á–µ–Ω–∏—è
                </th>
                <th class="px-2 sm:px-6 py-2 sm:py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  –°—Ç–æ–∏–º–æ—Å—Ç—å
                </th>
                <th class="px-2 sm:px-6 py-2 sm:py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden md:table-cell">
                  –≠–∫–∑–∞–º–µ–Ω—ã
                </th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <tr v-for="program in school.programs" :key="program.id">
                <td class="px-2 sm:px-6 py-2 sm:py-4 whitespace-normal">
                  <div class="font-medium text-gray-900">{{ program.name }}</div>
                  <div class="text-xs sm:text-sm text-gray-500 line-clamp-2">{{ program.description }}</div>
                </td>
                <td class="px-2 sm:px-6 py-2 sm:py-4 whitespace-nowrap text-sm text-gray-500 hidden sm:table-cell">
                  {{ program.code || '‚Äî' }}
                </td>
                <td class="px-2 sm:px-6 py-2 sm:py-4 whitespace-nowrap text-sm text-gray-500">
                  {{ program.duration }}
                </td>
                <td class="px-2 sm:px-6 py-2 sm:py-4 whitespace-nowrap text-sm text-gray-500">
                  {{ program.price ? `${program.price.toLocaleString()} ‚Ç∏` : '–ü–æ –∑–∞–ø—Ä–æ—Å—É' }}
                </td>
                <td class="px-2 sm:px-6 py-2 sm:py-4 text-sm text-gray-500 hidden md:table-cell">
                  <div v-if="hasExamRequirements(program)" class="mt-4 border-t pt-3">
                    <h4 class="text-sm font-semibold mb-2">–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —ç–∫–∑–∞–º–µ–Ω–∞–º:</h4>
                    <div class="overflow-x-auto">
                      <table class="min-w-full text-sm">
                        <thead>
                          <tr class="border-b bg-gray-50">
                            <th class="py-2 px-3 text-left">–≠–∫–∑–∞–º–µ–Ω</th>
                            <th class="py-2 px-3 text-right">–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–ª</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr v-for="(exam, examIndex) in parseExamRequirements(program)" :key="`exam-${program.id}-${examIndex}`" class="border-b">
                            <td class="py-2 px-3">{{ exam.name }}</td>
                            <td class="py-2 px-3 text-right">{{ exam.minScore }}</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                  <span v-else>‚Äî</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- –û—Ç–∑—ã–≤—ã -->
      <Reviews 
        :schoolId="schoolId" 
        :isAuthenticated="!!token" 
        :currentUser="user" 
        :isAdmin="user?.role === 'ADMIN'"
      />
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted, onUnmounted } from 'vue'
import { useRoute, navigateTo, useHead } from '#imports'
import LocationEditor from '~/components/LocationEditor.vue'
import SchoolMap from '~/components/SchoolMap.vue'
import ExternalReviews from '~/components/ExternalReviews.vue'
import { useSavedSchools } from '~/composables/useSavedSchools'
import ImageLoader from '~/components/ImageLoader.vue'

definePageMeta({
  layout: 'default'
})

const route = useRoute()
const schoolId = parseInt(route.params.id)

const school = ref(null)
const isLoading = ref(true)
const token = ref(null)
const user = ref(null)
const mapInstance = ref(null)

// –ò—Å–ø–æ–ª—å–∑—É–µ–º composable –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º–∏ —à–∫–æ–ª–∞–º–∏
const { isSchoolSaved, loadSavedSchools, toggleSaveSchool: toggleSaveSchoolAction } = useSavedSchools()

// –ü—Ä–æ–≤–µ—Ä–∫–∞, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–∏ —É—á–µ–±–Ω–æ–µ –∑–∞–≤–µ–¥–µ–Ω–∏–µ
const isSaved = computed(() => {
  return isSchoolSaved(schoolId)
})

// –ü–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏—è –≤—ã–∑–æ–≤–∞ –≤ composable
const toggleSaveSchool = () => {
  toggleSaveSchoolAction(schoolId)
}

// –î–∞–Ω–Ω—ã–µ –¥–ª—è –≥–∞–ª–µ—Ä–µ–∏
const galleryOpen = ref(false)
const currentImageIndex = ref(0)
const currentImage = ref('')
const currentDescription = ref('')

// –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª—ã –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è –¥–ª—è –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
const getInitials = (name) => {
  return name
    .split(' ')
    .map(word => word[0])
    .join('')
    .substring(0, 2)
    .toUpperCase()
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
const formatDate = (dateStr) => {
  const date = new Date(dateStr)
  return date.toLocaleDateString('ru-RU', {
    day: 'numeric',
    month: 'long',
    year: 'numeric'
  })
}

// –û—Ç–∫—Ä—ã—Ç–∏–µ –≥–∞–ª–µ—Ä–µ–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
const openGallery = (imageUrl, description) => {
  if (!school.value || !school.value.photos || school.value.photos.length === 0) return
  
  const index = school.value.photos.findIndex(p => p.url === imageUrl)
  currentImageIndex.value = index >= 0 ? index : 0
  currentImage.value = imageUrl || ''
  currentDescription.value = description || ''
  galleryOpen.value = true
  
  // –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  document.body.style.overflow = 'hidden'
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –≥–∞–ª–µ—Ä–µ–∏
const closeGallery = () => {
  galleryOpen.value = false
  
  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–∫—Ä–æ–ª–ª —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  document.body.style.overflow = ''
}

// –ü–µ—Ä–µ–π—Ç–∏ –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é
const prevImage = () => {
  if (currentImageIndex.value > 0) {
    currentImageIndex.value--
    const photo = school.value.photos[currentImageIndex.value]
    currentImage.value = photo.url || ''
    currentDescription.value = photo.description || ''
  }
}

// –ü–µ—Ä–µ–π—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é
const nextImage = () => {
  if (currentImageIndex.value < school.value.photos.length - 1) {
    currentImageIndex.value++
    const photo = school.value.photos[currentImageIndex.value]
    currentImage.value = photo.url || ''
    currentDescription.value = photo.description || ''
  }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –∫–ª–∞–≤–∏—à –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≥–∞–ª–µ—Ä–µ–µ–π
const handleKeydown = (e) => {
  if (!galleryOpen.value) return
  
  switch (e.key) {
    case 'Escape':
      closeGallery()
      break
    case 'ArrowLeft':
      prevImage()
      break
    case 'ArrowRight':
      nextImage()
      break
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
const loadUserData = async () => {
  token.value = localStorage.getItem('token')
  if (!token.value) return
  
  try {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —à–∫–æ–ª—ã
    await loadSavedSchools()
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const response = await fetch('/api/users/me', {
      headers: {
        'Authorization': `Bearer ${token.value}`
      }
    })
    
    if (response.ok) {
      const userData = await response.json()
      if (userData && userData.id) {
        user.value = userData
        console.log('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', user.value.name)
      }
    } else {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', response.status)
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error)
  }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —à–∫–æ–ª—ã
const updateCoordinates = (newCoordinates) => {
  if (school.value) {
    school.value.coordinates = newCoordinates
    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã —Å –Ω–æ–≤—ã–º–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏
    initMap()
  }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –Ø–Ω–¥–µ–∫—Å
const initMap = () => {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≥—Ä—É–∂–µ–Ω –ª–∏ API –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç –∏ –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –æ —à–∫–æ–ª–µ
  if (window.ymaps && school.value) {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ API
    ymaps.ready(() => {
      // –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –∫–∞—Ä—Ç—ã —Å —Ü–µ–Ω—Ç—Ä–æ–º –≤ –ê–ª–º–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      const map = new ymaps.Map('map', {
        center: [43.238949, 76.889709], // –ê–ª–º–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        zoom: 15
      })
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –∫–∞—Ä—Ç—ã
      mapInstance.value = map
      
      // –ï—Å–ª–∏ —É —à–∫–æ–ª—ã –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö
      if (school.value.coordinates) {
        try {
          // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ "lat,lng"
          const [lat, lng] = school.value.coordinates.split(',').map(coord => parseFloat(coord.trim()))
          
          if (!isNaN(lat) && !isNaN(lng)) {
            const coords = [lat, lng]
            map.setCenter(coords)
            
            // –†–∞–∑–º–µ—â–µ–Ω–∏–µ –º–µ—Ç–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ
            const placemark = new ymaps.Placemark(coords, {
              hintContent: school.value.name,
              balloonContent: `
                <strong>${school.value.name}</strong><br>
                ${school.value.address}<br>
                ${school.value.contacts}
              `
            }, {
              preset: 'islands#blueEducationIcon'
            })
            
            map.geoObjects.add(placemark)
            return // –ï—Å–ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —É—Å–ø–µ—à–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã, –∑–∞–≤–µ—Ä—à–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç:', error)
          // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
        }
      }
      
      // –ï—Å–ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–µ —É–∫–∞–∑–∞–Ω—ã –∏–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∏—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å, –ø—Ä–æ–±—É–µ–º –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –∞–¥—Ä–µ—Å—É
      if (school.value.address) {
        const addressForGeocode = school.value.address
        
        ymaps.geocode(addressForGeocode).then(res => {
          const firstGeoObject = res.geoObjects.get(0)
          if (firstGeoObject) {
            const coords = firstGeoObject.geometry.getCoordinates()
            map.setCenter(coords)
            
            // –†–∞–∑–º–µ—â–µ–Ω–∏–µ –º–µ—Ç–∫–∏
            const placemark = new ymaps.Placemark(coords, {
              hintContent: school.value.name,
              balloonContent: `
                <strong>${school.value.name}</strong><br>
                ${school.value.address}<br>
                ${school.value.contacts}
              `
            }, {
              preset: 'islands#blueEducationIcon'
            })
            
            map.geoObjects.add(placemark)
          }
        }).catch(error => {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–∏:', error)
        })
      }
    })
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç API
const loadYandexMapsApi = () => {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≥—Ä—É–∂–µ–Ω –ª–∏ —É–∂–µ API (–±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è ID —Å–∫—Ä–∏–ø—Ç–∞)
  if (window.ymaps) {
    return initMap();
  }
  
  // –ü–æ–ª—É—á–∞–µ–º API –∫–ª—é—á –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
  const config = useRuntimeConfig();
  const apiKey = config.public.yandexMapsApiKey;
  
  // –î–æ–±–∞–≤–ª—è–µ–º —Å–∫—Ä–∏–ø—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
  const script = document.createElement('script');
  script.src = `https://api-maps.yandex.ru/2.1/?apikey=${apiKey}&lang=ru_RU`;
  script.async = true;
  script.onload = initMap;
  document.head.appendChild(script);
}

// –ü–∞—Ä—Å–∏–Ω–≥ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
const contactData = computed(() => {
  if (!school.value || !school.value.contacts) return {}
  
  try {
    const contactsData = typeof school.value.contacts === 'string' 
      ? JSON.parse(school.value.contacts)
      : school.value.contacts
    
    return {
      phones: contactsData.phones || [],
      fax: contactsData.fax || '',
      messengers: contactsData.messengers || [],
      workingHours: contactsData.workingHours || '',
      socialNetworks: contactsData.socialNetworks || []
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–±–æ—Ä–µ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:', error)
    return {}
  }
})

// –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ –¥–ª—è –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞
const getMessengerIcon = (type) => {
  switch (type) {
    case 'whatsapp': return 'üì± WhatsApp:'
    case 'telegram': return 'üì® Telegram:'
    case 'viber': return 'üìû Viber:'
    default: return 'üì±'
  }
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ –¥–ª—è —Å–æ—Ü–∏–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏
const getSocialIcon = (type) => {
  switch (type) {
    case 'vk': return 'üí¨'
    case 'instagram': return 'üì∑'
    case 'facebook': return 'üëç'
    case 'youtube': return 'üì∫'
    default: return 'üîó'
  }
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è —Å–æ—Ü–∏–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏
const getSocialName = (type) => {
  switch (type) {
    case 'vk': return '–í–ö–æ–Ω—Ç–∞–∫—Ç–µ'
    case 'instagram': return 'Instagram'
    case 'facebook': return 'Facebook'
    case 'youtube': return 'YouTube'
    default: return type
  }
}

// –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —ç–∫–∑–∞–º–µ–Ω–∞–º
const hasExamRequirements = (program) => {
  return program.examRequirements && 
        (typeof program.examRequirements === 'string' ? 
          program.examRequirements.length > 0 : 
          program.examRequirements.length > 0);
}

// –ü–∞—Ä—Å–∏—Ç JSON-—Å—Ç—Ä–æ–∫—É —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ —ç–∫–∑–∞–º–µ–Ω–∞–º
const parseExamRequirements = (program) => {
  if (!program.examRequirements) return [];
  
  if (typeof program.examRequirements === 'string') {
    try {
      return JSON.parse(program.examRequirements);
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ —ç–∫–∑–∞–º–µ–Ω–∞–º:', e);
      return [];
    }
  }
  
  return program.examRequirements;
}

// –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
onMounted(async () => {
  // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–∫–µ–Ω–∞ –∏–∑ localStorage
  if (process.client) {
    token.value = localStorage.getItem('token')
  }
  
  try {
    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ —à–∫–æ–ª–µ
    const response = await fetch(`/api/schools/${schoolId}`)
    
    if (!response.ok) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ —à–∫–æ–ª–µ:', response.status)
      return
    }
    
    const data = await response.json()
    if (data && data.body) {
      school.value = data.body
      
      // –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
      console.log('Catalog/[id]: –ó–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –æ —à–∫–æ–ª–µ. Coordinates:', school.value.coordinates, 
                  'Latitude:', school.value.latitude, 'Longitude:', school.value.longitude)
      
      // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–∫–µ–Ω
      if (token.value) {
        await loadUserData()
      }
      
      // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      useHead({
        title: `${school.value.name} - –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –∞–±–∏—Ç—É—Ä–∏–µ–Ω—Ç–æ–≤`
      })
    } else {
      console.error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –æ —à–∫–æ–ª–µ:', data)
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ —à–∫–æ–ª–µ:', error)
  } finally {
    isLoading.value = false
  }
  
  // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –∫–ª–∞–≤–∏—à –¥–ª—è –≥–∞–ª–µ—Ä–µ–∏
  window.addEventListener('keydown', handleKeydown)
})

onUnmounted(() => {
  // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –∫–ª–∞–≤–∏—à –ø—Ä–∏ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
  window.removeEventListener('keydown', handleKeydown)
})

// –ò—Å–ø–æ–ª—å–∑—É–µ–º computed –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
const pageTitle = computed(() => {
  return school.value 
    ? `${school.value.name} - –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –∞–±–∏—Ç—É—Ä–∏–µ–Ω—Ç–æ–≤` 
    : '–£—á–µ–±–Ω–æ–µ –∑–∞–≤–µ–¥–µ–Ω–∏–µ - –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –∞–±–∏—Ç—É—Ä–∏–µ–Ω—Ç–æ–≤'
})

// –ü—Ä–∏–º–µ–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
useHead({
  title: pageTitle
})
</script> 